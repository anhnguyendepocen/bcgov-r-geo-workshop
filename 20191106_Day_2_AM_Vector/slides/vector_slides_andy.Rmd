---
title: "Introduction to Vector Data with R"
subtitle: "Practical Examples Using sf, ggplot2 and dplyr"
author: "Andy Teucher <br> Ministry of Environment and Climate Change Strategy <br><br> Sam Albers <br> Ministry of Citizens' Services <br><br> "
date: 2019-11-06
output:
  xaringan::moon_reader:
    keep_md: true
    lib_dir: libs
    css: ["default", "default-fonts", "hygge", "custom.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "https://platform.twitter.com/widgets.js"
      ratio: '16:9'
editor_options: 
  chunk_output_type: console
---

layout: true

---

```{r, include=FALSE}
# Copyright 2019 Province of British Columbia
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.
```


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(width = 90)
options(max_print = 5)

knitr::opts_chunk$set(
  collapse = TRUE,
  #echo = FALSE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.path = "graphics/prod/figs",
  fig.width = 8,
  fig.height = 5
)

options(scipen = 10)
```

```{r, pck-load, warning=FALSE, message=FALSE, include = FALSE}
library(knitr)
library(sf)
library(dplyr)
library(ggplot2)
library(bcdata)
library(ggspatial)
library(bcmaps)
library(here)
library(mapview)
library(kableExtra)
```


```{r, theme, warning=FALSE, echo=FALSE}
suppressWarnings(theme_set(theme_void()))


scale_colour_continuous <- scale_colour_viridis_c
scale_fill_continuous <- scale_fill_viridis_c
scale_colour_discrete <- scale_colour_viridis_d
scale_fill_discrete <- scale_fill_viridis_d

here_loc <- ifelse(dir.exists("data"), ".", "../..")
here::set_here(here_loc)

# read wrapper functions so slides render and work locally without
# explicitly using here::here()
st_read <- function(dsn, layer, ...) {
  sf::st_read(dsn = here::here(dsn), layer = layer, ...)
}

read_sf <- function(..., quiet = TRUE, stringsAsFactors = FALSE,
  as_tibble = TRUE) {
  st_read(..., quiet = quiet, stringsAsFactors = stringsAsFactors, 
        as_tibble = as_tibble)
}

read.csv <- function(file, ...) {
  utils::read.csv(file = here(file), ...)
}

```



## Outline

.VeryLarge[
- Brief review of dplyr
- 
- Multi layer plots with `ggplot2`
- Spatial Operations
- Making publication plots with `ggplot2`
]

---

class: middle

<center><img src="http://www.tailsfromthefield.net/wp-content/uploads/2014/07/5.VectorRaster.png" alt="Vector-Raster" /></center>

.footnote[Image: http://www.tailsfromthefield.net]

???
Spatial data divided into two categories: Vector and Raster

- vector data represents the world using points, lines and polygons. 
- discrete, well-defined borders, meaning that vector data usually have a high level of precision

- raster data divides the surface up into cells of constant size. 
- basis of background images used in web-mapping 
- aerial photography and satellite-based remote sensing devices. 
- Rasters aggregate spatially specific features to a given resolution, meaning that they are consistent over space and scalable.

---

class: middle

.pull-left[
  # Simple Features
  
  ### the 'sf' R package
  
  #### Replaces
  - sp
  - rgdal
  - rgeos
]

.pull-right[
  <center><img src="https://geocompr.robinlovelace.net/figures/sf-classes.png" alt="Simple Features" style="width: 600px;"/></center>
]

.footnote[
  sf package: https://cran.r-project.org/package=sf
  
  Geocomputation with R, fig 2.2: https://geocompr.robinlovelace.net
]

???

- Simple Features is a standard specification (Open Geospatial Consortium) - 
agreed-upon way to represent vector spatial data
- represent all common vector geometry types : points, lines, polygons and their respective ‘multi’ versions 
- supports geometry collections, which can contain multiple geometry types in a single object. 
- sf supersedes the sp ecosystem, which comprises sp , rgdal for data read/write  and rgeos for spatial operations.

---

## Reading and previewing spatial data

.pull-left[
```{r, eval=FALSE}
library(sf)
library(mapview)
```

```{r}
airports <- st_read("data/20191106_Day_2_AM_Vector/bc_airports.gpkg", quiet = TRUE)
```
]

.pull-right[
```{r fig.width=5}
mapview(airports)
```
]

---

# mapview


```{r fig.width=10}
mapview(airports, zcol = "NUMBER_OF_RUNWAYS")
```


---

# Structure of an `sf` object

```{r}
airports
```

???

go through sf header info:
- size (# of features and # of columns/attributes)
- geometry type
- dimension (XY - can have Z and M)
- bbox
- epsg
- proj4

---

# Key features of an `sf` object

```{r message=TRUE}

st_geometry(airports)

st_bbox(airports)

st_crs(airports)
```

---

# An `sf` object is a `data.frame`

```{r}
class(airports)
is.data.frame(airports)
summary(airports)

```

---

## We can turn it into a normal `data.frame`

```{r}
airports_df <- st_drop_geometry(airports)
head(airports_df)
```

---

## Coordinate Reference Systems
.pull-left[
### Geographic
- spherical or ellipsoidal surface; ellipsoid defined by the _datum_
- lat/long, measured in angular distances (degrees/radians)

<center><img src="https://upload.wikimedia.org/wikipedia/commons/a/af/Azimutalprojektion-schief_kl.jpg" alt="geocrs" /></center>
]

.pull-right[
### Projected
- Cartesian coordinates on a flat plane
- origin, x and y axes, linear unit of measurement (e.g., m)

<center><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Albers_projection_SW.jpg/1920px-Albers_projection_SW.jpg" alt="geocrs" /></center>
]

.small.pull-left[https://en.wikipedia.org/wiki/Geographic_coordinate_system]
.small.pull-right[https://en.wikipedia.org/wiki/Albers_projection]

???

defines how the spatial elements of the data relate to the surface of the Earth

Geographic: 
- identify any location on the Earth’s surface using two values — longitude and latitude. 
- Longitude is location in the East-West direction in angular distance from the Prime Meridian plane. 
- Latitude is angular distance North or South of the equatorial plane. 
- Distances in geographic CRSs are therefore not measured in meters. This has important consequences

Projected:
- based on a geographic CRS
- rely on map projections to convert the three-dimensional surface of the Earth into Easting and Northing (x and y) values in a projected CRS
- often named based on a property they preserve: equal-area preserves area, azimuthal preserve direction, equidistant preserve distance, and conformal preserve local shape.
- conic, cylindrical, planar

---

# CRSs in R

```{r}
st_crs(airports)
```

.pull-left[
## BC Albers - B.C.'s standard projection
- Equal Area conic
- Centre: c(-126, 54)
https://epsg.io/3005
]

.pull-right[
```{r echo=FALSE}

albers_centre <- st_sfc(st_point(c(-126, 54)), crs = 4326) %>% 
  st_transform(3005)

ggplot() + 
  geom_sf(data = bc_bound()) + 
  geom_sf(data = albers_centre, colour = "blue", size = 5) + 
  geom_sf(data = bc_cities() %>% filter(NAME == "Burns Lake")) + 
  geom_sf_text(data = bc_cities() %>% filter(NAME == "Burns Lake"), aes(label = NAME), nudge_x = 100000, nudge_y = 30000)
  
```
]

???

EPSG codes
BC Albers

---

## Proj4 String

```{r}
st_crs(3005)$proj4string
```

.pull-left[
- projection (`proj`)
- standard parallels (`lat_1`, `lat_2`)
- origin (`lat_0`, `lon_0`, `x_0`, `y_0`)
- ellipsis (`ellps`)
- conversion to WGS84 `towgs84`
- `units`
- `no_defs` - no defaults are read from the defaults files
- `datum`
]

.pull-right[
```{r}
# one of "have_datum_files", "proj", "ellps", 
# "datum", "units" or "prime_meridians"
st_proj_info("proj") %>% head()

```
]

---

class: inverse, left, middle

# Your turn

.Large[
Read in the electoral districts data in the `data` folder.
- What type of geometry is it?
- What is the CRS?
- What is the EPSG code?
]

---

## Solution

```{r message=TRUE}
elec_bc <- read_sf("data/20191106_Day_2_AM_Vector/bc_electoral_districts.shp")
st_geometry(elec_bc)
st_crs(elec_bc)
```

https://epsg.io/4326

---

## Basic plotting

.pull-left[
```{r}
plot(elec_bc)
```
]

.pull-right[
```{r}
plot(elec_bc["ED_NAME"])
```
]


---

# Use `ggplot2::geom_sf()` to make nice maps

```{r eval=FALSE}
library(ggplot2)
```


```{r}
ggplot() + # leave this empty!
  geom_sf(data = elec_bc)
```

---

class: inverse, left, middle

## Your turn

### Load `"data/20191106_Day_2_AM_Vector/ski_resorts.csv"` as an `sf` object

```{r echo=FALSE}
kable(head(read.csv("data/20191106_Day_2_AM_Vector/ski_resorts.csv"), 
             format = "html"))
```

---

class: inverse, left, middle

## Hints:

### Load `"data/20191106_Day_2_AM_Vector/ski_resorts.csv"` as an `sf` object

```{r, eval=FALSE}
ski_resorts <- read.csv("data/20191106_Day_2_AM_Vector/ski_resorts.csv")
ski_resorts <- st_as_sf(ski_resorts, ...)
```

---

## Solution

```{r}
ski_resorts <- read.csv("data/20191106_Day_2_AM_Vector/ski_resorts.csv", 
                        stringsAsFactors = FALSE)

ski_resorts <- st_as_sf(ski_resorts, coords = c("longitude", "latitude"), 
                        crs = 4326)

head(ski_resorts)
```

---

## Use `ggplot2` `aes()`

```{r}
ggplot() + geom_sf(data = ski_resorts, aes(colour = elevation))
```

